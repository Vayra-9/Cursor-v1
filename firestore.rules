rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function hasRole(role) {
      return isAuthenticated() && getUserData().role == role;
    }
    
    function hasPlan(plan) {
      return isAuthenticated() && getUserData().plan == plan;
    }
    
    function isGrandfathered() {
      return isAuthenticated() && getUserData().grandfathered == true;
    }
    
    function hasProAccess() {
      return hasPlan('pro') || hasPlan('premium') || isGrandfathered();
    }
    
    function hasPremiumAccess() {
      return hasPlan('premium') || isGrandfathered();
    }
    
    // Users collection
    match /users/{userId} {
      allow read: if isOwner(userId);
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if false; // Soft delete only
    }
    
    // Debts collection
    match /debts/{debtId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Payments collection
    match /payments/{paymentId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Expenses collection
    match /expenses/{expenseId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Income collection
    match /income/{incomeId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Budgets collection
    match /budgets/{budgetId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Instant Queue (Offline Sync)
    match /instant_queue/{userId} {
      allow read, write: if isOwner(userId);
    }
    
    // Tasks collection (Pro+ feature)
    match /tasks/{taskId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid && hasProAccess();
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid && hasProAccess();
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid && hasProAccess();
    }
    
    // Goals collection (Pro+ feature)
    match /goals/{goalId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid && hasProAccess();
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid && hasProAccess();
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid && hasProAccess();
    }
    
    // Reports collection (Premium feature)
    match /reports/{reportId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid && hasPremiumAccess();
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid && hasPremiumAccess();
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid && hasPremiumAccess();
    }
    
    // Analytics collection
    match /analytics/{analyticsId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if false; // Analytics are immutable
    }
    
    // Referrals collection
    match /referrals/{referralId} {
      allow read: if isAuthenticated() && (resource.data.referrerId == request.auth.uid || resource.data.referredId == request.auth.uid);
      allow create: if isAuthenticated();
      allow update: if false; // Referrals are immutable
      allow delete: if false;
    }
    
    // Voice logs (Beta feature)
    match /voice_logs/{logId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if false;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Settings collection
    match /settings/{userId} {
      allow read, write: if isOwner(userId);
    }
    
    // Plans collection (read-only for users)
    match /plans/{planId} {
      allow read: if isAuthenticated();
      allow write: if false; // Admin only
    }
  }
}
